# 路由器体系结构
**路由器的两个关键功能:**
运行**路由**算法/协议(RIP, OSPF, BGP)
**转发**功能：将分组从路由器的输入链路传送到适当的输出链路。
![image.png](https://picgo-1310230783.cos.ap-chengdu.myqcloud.com/obsidian/202304271451772.png)
# 输入端口功能
第一个**线路端接**模块：将一条**物理链路端接到路由器**的物理层；
第二个**数据链路处理**模块：实现路由器的**数据链路层功能**；
第三个**查找与转发**模块：实现**查找与转发功能**，以便分组通过路由器交换结构转发到适当的输出端口；
![image.png](https://picgo-1310230783.cos.ap-chengdu.myqcloud.com/obsidian/202304271455296.png)
# 输入端口——查找/转发模块
确定**将一个到达的分组通过交换结构转发给哪个输出端口**。 通过查找**转发表**实现，这里的转发表是存储在输入端口的内存中。
**分布式交换**：
选路处理器计算转发表，给**每个输入端口存放一份转发表拷贝**。
**在每个输入端口本地做出交换决策**，无须激活中央选路处理器。
可避免在路由器中某个**单点**产生转发处理瓶颈。
目的：以线速完成输入端口的处理
排队：如果数据报到达输入端口的速度快于输入端口将数据报转发到交换结构的速度，就会发生排队
# 转发表
**路由器转发方法**：**根据到达分组的目的地址在转发表中查询**，找到相应的输出链路接口，并将分组转发出去。
转发表：每台路由器有一张。**目的地址与链路接口**的映射表。转发表中的表项数与地址位数有关，**每个可能的地址对应一项**。  
![image.png](https://picgo-1310230783.cos.ap-chengdu.myqcloud.com/obsidian/202304271459311.png)
# 数据报转发表
![image.png](https://picgo-1310230783.cos.ap-chengdu.myqcloud.com/obsidian/202304271501928.png)
**问题: 如果地址范围分配没有很合理，会发生什么问题？**
例如，在该第一个范围中说的一个地址子集应该去往接口3而不是接口0。那么，我们当然可以将第一个地址范围分成多个部分，并用 其新的目标输出端口。 但是事实证明，有一种更简单，更优雅的方法可以做到这一点， 称为**最长前缀匹配**。
# 最长前缀匹配
对于给定的目的地址，使用**最长**地址前缀匹配来完成输出端口的查找
![image.png](https://picgo-1310230783.cos.ap-chengdu.myqcloud.com/obsidian/202304271504125.png)
![image.png](https://picgo-1310230783.cos.ap-chengdu.myqcloud.com/obsidian/202306251431720.png)
![image.png](https://picgo-1310230783.cos.ap-chengdu.myqcloud.com/obsidian/202306251431929.png)
![image.png](https://picgo-1310230783.cos.ap-chengdu.myqcloud.com/obsidian/202306251432419.png)
我们将很快看到为什么要使用最长前缀匹配
最长前缀匹配 (longest prefix matching)：通常使用三态内容可寻址存储器（ternary content addressable memories, TCAM）执行内容可寻址
- **内容地址表 (content addressable)**: 存放地址到TCAM：在一个时钟周期内检索地址，而不管表的大小如何
- Cisco Catalyst: TCAM中有 ~1M 的路由表条目
# 说明
路由器转发表只维持转发状态信息；
转发表由选路算法修改（1～5分钟更新）；虚电路网络转发表随虚电路的建立和拆除更新。
一个端系统发送给另一个端系统的**一批分组可能在网络中选择不同的路径，到达的顺序可能不一致**。
![image.png](https://picgo-1310230783.cos.ap-chengdu.myqcloud.com/obsidian/202306251433715.png)
（1）分组的目的站IP地址是：128.96.39.10。
先与子网掩码255.255.255.128相与，得128.96.39.0，可见该分组经接口m0转发。
（2）分组的目的IP地址为：128.96.40.12。
与子网掩码255.255.255.128相与得128.96.40.0，经查路由表可知，该项分组经R2转发。
（3）分组的目的IP地址为：128.96.40.151，与子网掩码255.255.255.128相与后得128.96.40.128，与子网掩码255.255.255.192相与后得128.96.40.128，经查路由表知，该分组转发选择默认路由，经R4转发。
（4）分组的目的IP地址为：192.4.153.17。与子网掩码255.255.255.128相与后得192.4.153.0。与子网掩码255.255.255.192相与后得192.4.153.0，经查路由表知，该分组经R3转发。
（5）分组的目的IP地址为：192.4.153.90，与子网掩码255.255.255.128相与后得192.4.153.0。与子网掩码255.255.255.192相与后得192.4.153.64，经查路由表知，该分组经R3转发。

